FROM alpine:3.7 as builder
COPY kibana /kibana
RUN apk add --no-cache zip
RUN zip -r /tigera_customization.zip kibana

FROM docker.elastic.co/kibana/kibana:6.4.1
# custom favicons
COPY favicons/* /usr/share/kibana/src/ui/public/assets/favicons/
# custom throbber
RUN sed -i 's/image\/svg+xml.*");/image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjE2NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+LnN0MHtmaWxsOiNGRjlFMTY7fQoJLnN0MXtmaWxsOiMwRDBEMEQ7fTwvc3R5bGU+CgogPHRpdGxlPkFzc2V0IDE8L3RpdGxlPgogPGc+CiAgPHRpdGxlPmJhY2tncm91bmQ8L3RpdGxlPgogIDxyZWN0IGZpbGw9Im5vbmUiIGlkPSJjYW52YXNfYmFja2dyb3VuZCIgaGVpZ2h0PSIxNjgiIHdpZHRoPSIyNDIiIHk9Ii0xIiB4PSItMSIvPgogPC9nPgogPGc+CiAgPHRpdGxlPkxheWVyIDE8L3RpdGxlPgogIDxwYXRoIGlkPSJzdmdfMSIgZD0ibTIyNiw5Ni43Yy00LjIsNS4zIC05LjYsOS43IC0xNS42LDEyLjhjMy4yLC00LjEgNC41LC05LjEgNC40LC0xNC43Yy0yMC40LDAgLTM2LjUsMTMuMyAtMjguOSwzOWM0LjMsLTAuMyA2LjgsLTMuMyA5LjEsLTYuNWMwLjIsMy43IC0wLjcsNy43IC0zLjUsMTIuNGwxLjgsNC4yYy01LjMsMy44IC0xMywxMSAtMTkuMiw4LjljLTE2LjUsLTE5LjMgLTQyLjIsLTI0LjYgLTc1LjksLTRjMi40LC01LjkgNCwtMTAuMyA5LjMsLTE1Yy02LjIsLTAuMiAtMTcuOCwxLjQgLTI2LjgsNi40YzAuMiwtMjQuNyA0LC00OS4zIDExLjMsLTcyLjljLTE2LDI3LjYgLTIzLjgsNTkuOCAtMzEuOCw5OC42Yy04LjUsLTM2LjcgLTE0LjksLTYyLjQgLTkuMSwtMTA0LjRjLTE3LDMgLTM2LDE0LjMgLTUxLjEsMjMuOGMxOC4yLC0yNC4yIDU3LjQsLTUwLjIgNzQuNSwtNTUuMmMtOC4zLDEzLjUgLTEzLjYsMzIuMSAtMTQuOCw0Ny4zbDcuNywtMC43Yy0zLjEsNi44IC02LjMsMjIuNSAtNi4zLDM1LjdjMi4zLC0xNCA5LjMsLTMyLjYgMTYuNCwtNDQuM2wtOS40LDAuOGM1LjMsLTE4LjkgMTgsLTM3LjUgMjksLTQzLjhjNC44LC0xLjUgOS43LC0yLjIgMTQuNywtMS45Yy0xLjMsNy45IC03LjcsNDguMSAtNC41LDY2LjdjMC4xLC0xOS45IDkuNiwtNzUuNiAxNy4zLC04OS45YzEyLjMsMTAuOSAxNC40LDE1LjkgMTksMjUuNmMyNC4zLDEuMyA0My4yLDEyLjggNjAuOSwyNi40Yy0wLjQsMS40IC0xLjQsMi41IC0yLjgsMy4xYzQuNywxLjcgMTYuMyw4LjMgMjAuOCwxMi4xYzUuOSw1IDEzLjQsMTEuNiAxNy4xLDE2bC03LDExbC0zLjIsLTkuNWw2LjQsLTEuMWwtOC41LC0wLjFsMy41LDExLjZsLTQuOCwxLjZ6bS0zNC4zLC0yOS4ybC02LjUsLTguMmwtMTcuNiwtNS4xbDEwLjMsOC41bDYuMSwtMC4zbDcuNyw1LjF6IiBjbGFzcz0ic3QwIi8+CiA8L2c+Cjwvc3ZnPg==");/g' /usr/share/kibana/src/ui/ui_render/views/ui_app.jade /usr/share/kibana/src/ui/ui_render/views/chrome.jade

# custom plugin css
COPY --from=builder /tigera_customization.zip /
RUN sed -i "s/commons.style.css'),/commons.style.css'),createAnchor('{{bundlePath}}\/tigera_customization.style.css'),/g" /usr/share/kibana/src/ui/ui_render/bootstrap/template.js.hbs
RUN bin/kibana-plugin install file:///tigera_customization.zip
